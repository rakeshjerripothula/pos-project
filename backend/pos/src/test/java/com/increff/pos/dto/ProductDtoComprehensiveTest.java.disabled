package com.increff.pos.dto;

import com.increff.pos.exception.ApiException;
import com.increff.pos.exception.ApiStatus;
import com.increff.pos.model.data.FieldErrorData;
import com.increff.pos.model.data.ProductData;
import com.increff.pos.model.form.ProductForm;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import java.lang.reflect.Method;
import java.math.BigDecimal;
import java.util.Arrays;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

class ProductDtoComprehensiveTest {

    @Mock
    private com.increff.pos.flow.ProductFlow productFlow;

    @InjectMocks
    private ProductDto productDto;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void createProduct_validForm_success() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(new BigDecimal("10.99"));
        form.setClientId(1);
        form.setBarcode("BAR001");
        
        com.increff.pos.entity.ProductEntity savedProduct = createProductEntity(1, "Test Product",
                new BigDecimal("10.99"), 1, "BAR001");
        when(productFlow.createProduct(any())).thenReturn(savedProduct);

        // Act
        ProductData result = productDto.createProduct(form);

        // Assert
        assertNotNull(result);
        assertEquals(1, result.getId());
        assertEquals("Test Product", result.getProductName());
        assertEquals(new BigDecimal("10.99"), result.getMrp());
        assertEquals(1, result.getClientId());
        assertEquals("BAR001", result.getBarcode());
        verify(productFlow, times(1)).createProduct(any());
    }

    @Test
    void createProduct_invalidMrp_throwsException() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(BigDecimal.ZERO); // invalid
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Act
        ApiException exception = assertThrows(ApiException.class, () -> productDto.createProduct(form));

        // Assert: top-level exception
        assertEquals(ApiStatus.BAD_REQUEST, exception.getStatus());
        assertEquals("Input validation failed", exception.getMessage());

        // Assert: field-level validation error
        assertNotNull(exception.getErrors());
        assertEquals(1, exception.getErrors().size());

        FieldErrorData error = exception.getErrors().getFirst();
        assertEquals("mrp", error.getField());
        assertEquals("MRP must be greater than 0", error.getMessage());

        // Assert: API not invoked
        verify(productFlow, never()).createProduct(any());
    }

    @Test
    void createProduct_nullForm_throwsException() {
        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> productDto.createProduct(null));
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        verify(productFlow, never()).createProduct(any());
    }

    @Test
    void updateProduct_validForm_success() {
        // Arrange
        Integer productId = 1;
        ProductForm form = new ProductForm();
        form.setProductName("Updated Product");
        form.setMrp(new BigDecimal("15.99"));
        form.setClientId(2);
        form.setBarcode("BAR002");
        
        com.increff.pos.entity.ProductEntity updatedProduct = createProductEntity(productId, "Updated Product", new BigDecimal("15.99"), 2, "BAR002");
        when(productFlow.updateProduct(eq(productId), any())).thenReturn(updatedProduct);

        // Act
        ProductData result = productDto.updateProduct(productId, form);

        // Assert
        assertNotNull(result);
        assertEquals(productId, result.getId());
        assertEquals("Updated Product", result.getProductName());
        assertEquals(new BigDecimal("15.99"), result.getMrp());
        verify(productFlow, times(1)).updateProduct(eq(productId), any());
    }

    @Test
    void updateProduct_invalidProductId_throwsException() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(new BigDecimal("10.99"));
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> productDto.updateProduct(null, form));
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        assertTrue(exception.getMessage().contains("Product ID is required"));
        verify(productFlow, never()).updateProduct(any(), any());
    }

    @Test
    void updateProduct_invalidForm_throwsException() {
        // Arrange
        Integer productId = 1;
        ProductForm form = new ProductForm();
        form.setProductName(""); // invalid
        form.setMrp(new BigDecimal("10.99"));
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Act
        ApiException exception = assertThrows(
                ApiException.class,
                () -> productDto.updateProduct(productId, form)
        );

        // Assert: top-level exception
        assertEquals(ApiStatus.BAD_REQUEST, exception.getStatus());
        assertEquals("Input validation failed", exception.getMessage());

        // Assert: field-level validation errors
        assertNotNull(exception.getErrors());
        assertEquals(1, exception.getErrors().size());

        FieldErrorData error = exception.getErrors().get(0);
        assertEquals("productName", error.getField());
        assertEquals("Product name is required", error.getMessage());

        // Assert: API not invoked
        verify(productFlow, never()).updateProduct(any(), any());
    }


    @Test
    void bulkCreateProducts_validForms_success() throws Exception {
        // Arrange
        List<ProductForm> forms = Arrays.asList(
            createProductForm("Product 1", new BigDecimal("10.99"), 1, "BAR001"),
            createProductForm("Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );
        
        List<com.increff.pos.entity.ProductEntity> savedProducts = Arrays.asList(
            createProductEntity(1, "Product 1", new BigDecimal("10.99"), 1, "BAR001"),
            createProductEntity(2, "Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );
        
        when(productFlow.bulkCreateProducts(any())).thenReturn(savedProducts);

        // Use reflection to access private method
        Method bulkCreateProductsMethod = ProductDto.class.getDeclaredMethod("bulkCreateProducts", List.class);
        bulkCreateProductsMethod.setAccessible(true);
        @SuppressWarnings("unchecked")
        List<ProductData> result = (List<ProductData>) bulkCreateProductsMethod.invoke(productDto, forms);

        // Assert
        assertNotNull(result);
        assertEquals(2, result.size());
        assertEquals("Product 1", result.get(0).getProductName());
        assertEquals("Product 2", result.get(1).getProductName());
        verify(productFlow, times(1)).bulkCreateProducts(any());
    }

    @Test
    void bulkCreateProducts_invalidForm_throwsException() throws Exception {
        // Arrange
        List<ProductForm> forms = List.of(
                createProductForm("", new BigDecimal("10.99"), 1, "BAR001")
        );

        // Use reflection to access private method
        Method bulkCreateProductsMethod = ProductDto.class.getDeclaredMethod("bulkCreateProducts", List.class);
        bulkCreateProductsMethod.setAccessible(true);

        // Act
        ApiException exception = assertThrows(
                ApiException.class,
                () -> {
                    try {
                        bulkCreateProductsMethod.invoke(productDto, forms);
                    } catch (Exception e) {
                        if (e.getCause() instanceof ApiException) {
                            throw (ApiException) e.getCause();
                        }
                        throw new RuntimeException(e);
                    }
                }
        );

        // Assert: top-level exception
        assertEquals(ApiStatus.BAD_REQUEST, exception.getStatus());
        assertEquals("Input validation failed", exception.getMessage());

        // Assert: field-level validation error
        assertNotNull(exception.getErrors());
        assertEquals(1, exception.getErrors().size());

        FieldErrorData error = exception.getErrors().get(0);
        assertEquals("productName", error.getField());
        assertEquals("Product name is required", error.getMessage());

        // Assert: API not invoked
        verify(productFlow, never()).bulkCreateProducts(any());
    }

    @Test
    void getAll_success() {
        // Arrange
        List<com.increff.pos.entity.ProductEntity> products = Arrays.asList(
            createProductEntity(1, "Product 1", new BigDecimal("10.99"), 1, "BAR001"),
            createProductEntity(2, "Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );
        when(productFlow.getAll()).thenReturn(products);

        // Act
        List<ProductData> result = productDto.getAll();

        // Assert
        assertNotNull(result);
        assertEquals(2, result.size());
        assertEquals("Product 1", result.get(0).getProductName());
        assertEquals("Product 2", result.get(1).getProductName());
        verify(productFlow, times(1)).getAll();
    }

    private com.increff.pos.entity.ProductEntity createProductEntity(Integer id, String name, BigDecimal mrp, Integer clientId, String barcode) {
        com.increff.pos.entity.ProductEntity product = new com.increff.pos.entity.ProductEntity();
        product.setId(id);
        product.setProductName(name);
        product.setMrp(mrp);
        product.setClientId(clientId);
        product.setBarcode(barcode);
        return product;
    }

    private ProductForm createProductForm(String name, BigDecimal mrp, Integer clientId, String barcode) {
        ProductForm form = new ProductForm();
        form.setProductName(name);
        form.setMrp(mrp);
        form.setClientId(clientId);
        form.setBarcode(barcode);
        return form;
    }
}
