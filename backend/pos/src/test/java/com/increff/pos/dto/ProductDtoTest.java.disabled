package com.increff.pos.dto;

import com.increff.pos.exception.ApiException;
import com.increff.pos.model.data.PagedResponse;
import com.increff.pos.model.data.ProductData;
import com.increff.pos.model.data.TsvUploadError;
import com.increff.pos.model.data.TsvUploadResult;
import com.increff.pos.model.form.ProductForm;
import com.increff.pos.model.form.ProductSearchForm;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.web.multipart.MultipartFile;

import java.lang.reflect.Method;
import java.math.BigDecimal;
import java.util.Arrays;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

class ProductDtoTest {

    @Mock
    private com.increff.pos.flow.ProductFlow productFlow;

    @InjectMocks
    private ProductDto productDto;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
    }

    @Test
    void testParseProductTsv_WithValidData() throws Exception {
        // Mock client name to ID resolution
        when(productFlow.getClientIdByName("Client 1")).thenReturn(1);
        when(productFlow.getClientIdByName("Client 2")).thenReturn(2);
        
        String tsvContent = """
                productName\tmrp\tclientName\tbarcode
                Test Product 1\t10.99\tClient 1\tBAR001
                Test Product 2\t20.50\tClient 2\tBAR002
                """;
        
        MultipartFile file = new MockMultipartFile(
            "file", 
            "products.tsv", 
            "text/tab-separated-values", 
            tsvContent.getBytes()
        );

        // Use reflection to access private method
        Method parseProductTsvMethod = ProductDto.class.getDeclaredMethod("parseProductTsv", MultipartFile.class);
        parseProductTsvMethod.setAccessible(true);
        @SuppressWarnings("unchecked")
        TsvUploadResult<ProductForm> result = (TsvUploadResult<ProductForm>) parseProductTsvMethod.invoke(productDto, file);

        System.out.println("Result success: " + result.isSuccess());
        if (!result.isSuccess()) {
            System.out.println("Errors: " + result.getErrors());
            for (TsvUploadError error : result.getErrors()) {
                System.out.println("Error: " + error.getErrorMessage());
            }
        }

        assertTrue(result.isSuccess());
        assertNotNull(result.getData());
        assertEquals(2, result.getData().size());
        assertNull(result.getErrors());
    }

    @Test
    void testParseProductTsv_WithInvalidData() throws Exception {
        String tsvContent = """
                productName\tmrp\tclientName\tbarcode
                Test Product 1\tinvalid_mrp\tClient 1\tBAR001
                \t20.50\tClient 2\tBAR002
                Test Product 3\t-5.00\tClient 3\tBAR003
                """;
        
        MultipartFile file = new MockMultipartFile(
            "file", 
            "products.tsv", 
            "text/tab-separated-values", 
            tsvContent.getBytes()
        );

        // Use reflection to access private method
        Method parseProductTsvMethod = ProductDto.class.getDeclaredMethod("parseProductTsv", MultipartFile.class);
        parseProductTsvMethod.setAccessible(true);
        @SuppressWarnings("unchecked")
        TsvUploadResult<ProductForm> result = (TsvUploadResult<ProductForm>) parseProductTsvMethod.invoke(productDto, file);

        assertFalse(result.isSuccess());
        assertNotNull(result.getErrors());
        assertEquals(2, result.getErrors().size());
        assertNull(result.getData());
        
        List<TsvUploadError> errors = result.getErrors();
        
        // Check first error - invalid MRP format
        TsvUploadError error1 = errors.get(0);
        assertEquals(3, error1.getRowNumber());
        assertTrue(error1.getErrorMessage().contains("Invalid MRP format"));
        
        // Check second error - negative MRP
        TsvUploadError error2 = errors.get(1);
        assertEquals(5, error2.getRowNumber());
        assertTrue(error2.getErrorMessage().contains("MRP must be greater than 0"));
        
        }

    @Test
    void testParseProductTsv_WithInsufficientColumns() throws Exception {
        String tsvContent = "productName\tmrp\tclientName\tbarcode\n" +
                "Test Product 1\t10.99\tClient 1\n"; // Missing barcode
        
        MultipartFile file = new MockMultipartFile(
            "file", 
            "products.tsv", 
            "text/tab-separated-values", 
            tsvContent.getBytes()
        );

        // Use reflection to access private method
        Method parseProductTsvMethod = ProductDto.class.getDeclaredMethod("parseProductTsv", MultipartFile.class);
        parseProductTsvMethod.setAccessible(true);
        @SuppressWarnings("unchecked")
        TsvUploadResult<ProductForm> result = (TsvUploadResult<ProductForm>) parseProductTsvMethod.invoke(productDto, file);

        assertFalse(result.isSuccess());
        assertNotNull(result.getErrors());
        assertEquals(1, result.getErrors().size());
        
        TsvUploadError error = result.getErrors().getFirst();
        assertEquals(2, error.getRowNumber());
        assertTrue(error.getErrorMessage().contains("Expected at least 4 columns"));
    }

    @Test
    void createProduct_validForm_success() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(new BigDecimal("10.99"));
        form.setClientId(1);
        form.setBarcode("BAR001");
        
        com.increff.pos.entity.ProductEntity savedProduct = createProductEntity(1, "Test Product", new BigDecimal("10.99"), 1, "BAR001");
        when(productFlow.createProduct(any())).thenReturn(savedProduct);

        // Act
        ProductData result = productDto.createProduct(form);

        // Assert
        assertNotNull(result);
        assertEquals(1, result.getId());
        assertEquals("Test Product", result.getProductName());
        assertEquals(new BigDecimal("10.99"), result.getMrp());
        assertEquals(1, result.getClientId());
        assertEquals("BAR001", result.getBarcode());
        verify(productFlow, times(1)).createProduct(any());
    }

    @Test
    void createProduct_invalidMrp_throwsException() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(new BigDecimal("-1.00")); // Invalid MRP (negative)
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> productDto.createProduct(form));
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        assertTrue(exception.hasErrors());
        assertTrue(exception.getErrors().getFirst().getMessage().contains("MRP must be greater than 0"));
        verify(productFlow, never()).createProduct(any());
    }

    @Test
    void createProduct_nullForm_throwsException() {
        // Act & Assert
        assertThrows(ApiException.class, () -> productDto.createProduct(null));
        verify(productFlow, never()).createProduct(any());
    }

    @Test
    void updateProduct_validForm_success() {
        // Arrange
        Integer productId = 1;
        ProductForm form = new ProductForm();
        form.setProductName("Updated Product");
        form.setMrp(new BigDecimal("15.99"));
        form.setClientId(2);
        form.setBarcode("BAR002");
        
        com.increff.pos.entity.ProductEntity updatedProduct = createProductEntity(productId, "Updated Product", new BigDecimal("15.99"), 2, "BAR002");
        when(productFlow.updateProduct(eq(productId), any())).thenReturn(updatedProduct);

        // Act
        ProductData result = productDto.updateProduct(productId, form);

        // Assert
        assertNotNull(result);
        assertEquals(productId, result.getId());
        assertEquals("Updated Product", result.getProductName());
        assertEquals(new BigDecimal("15.99"), result.getMrp());
        verify(productFlow, times(1)).updateProduct(eq(productId), any());
    }

    @Test
    void updateProduct_invalidProductId_throwsException() {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(new BigDecimal("10.99"));
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> productDto.updateProduct(null, form));
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        assertTrue(exception.getMessage().contains("Product ID is required"));
        verify(productFlow, never()).updateProduct(any(), any());
    }

    @Test
    void bulkCreateProducts_validForms_success() throws Exception {
        // Arrange
        List<ProductForm> forms = Arrays.asList(
            createProductForm("Product 1", new BigDecimal("10.99"), 1, "BAR001"),
            createProductForm("Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );
        
        List<com.increff.pos.entity.ProductEntity> savedProducts = Arrays.asList(
            createProductEntity(1, "Product 1", new BigDecimal("10.99"), 1, "BAR001"),
            createProductEntity(2, "Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );
        
        when(productFlow.bulkCreateProducts(any())).thenReturn(savedProducts);

        // Use reflection to access private method
        Method bulkCreateProductsMethod = ProductDto.class.getDeclaredMethod("bulkCreateProducts", List.class);
        bulkCreateProductsMethod.setAccessible(true);
        @SuppressWarnings("unchecked")
        List<ProductData> result = (List<ProductData>) bulkCreateProductsMethod.invoke(productDto, forms);

        // Assert
        assertNotNull(result);
        assertEquals(2, result.size());
        assertEquals("Product 1", result.get(0).getProductName());
        assertEquals("Product 2", result.get(1).getProductName());
        verify(productFlow, times(1)).bulkCreateProducts(any());
    }

    @Test
    void bulkCreateProducts_invalidForm_throwsException() throws Exception {
        // Arrange
        List<ProductForm> forms = List.of(
                createProductForm("", new BigDecimal("10.99"), 1, "BAR001") // Invalid: empty name
        );

        // Use reflection to access private method
        Method bulkCreateProductsMethod = ProductDto.class.getDeclaredMethod("bulkCreateProducts", List.class);
        bulkCreateProductsMethod.setAccessible(true);

        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> {
            try {
                bulkCreateProductsMethod.invoke(productDto, forms);
            } catch (Exception e) {
                if (e.getCause() instanceof ApiException) {
                    throw (ApiException) e.getCause();
                }
                throw new RuntimeException(e);
            }
        });
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        assertTrue(exception.hasErrors());
        assertTrue(exception.getErrors().getFirst().getMessage().contains("Product name is required"));
        verify(productFlow, never()).bulkCreateProducts(any());
    }

    @Test
    void testGetAll() {
        // Arrange
        List<com.increff.pos.entity.ProductEntity> entities = Arrays.asList(
                createProductEntity(1, "Product 1", new BigDecimal("10.99"), 1, "BAR001"),
                createProductEntity(2, "Product 2", new BigDecimal("15.99"), 2, "BAR002")
        );

        when(productFlow.getAll()).thenReturn(entities);

        // Act
        List<ProductData> result = productDto.getAll();

        // Assert
        assertEquals(2, result.size());
        assertEquals("Product 1", result.get(0).getProductName());
        assertEquals("Product 2", result.get(1).getProductName());
        verify(productFlow).getAll();
    }

    @Test
    void testListProducts() {
        // Arrange
        ProductSearchForm form = new ProductSearchForm();
        form.setPage(0);
        form.setPageSize(10);
        form.setClientId(1);
        form.setBarcode("BAR001");
        form.setProductName("Test Product");

        com.increff.pos.entity.ProductEntity entity = createProductEntity(1, "Test Product", new BigDecimal("10.99"), 1, "BAR001");
        Page<com.increff.pos.entity.ProductEntity> page = new PageImpl<>(List.of(entity));

        when(productFlow.searchProducts(any(), any(), any(), any())).thenReturn(page);

        // Act
        PagedResponse<ProductData> result = productDto.listProducts(form);

        // Assert
        assertNotNull(result);
        assertEquals(1, result.getData().size());
        assertEquals(1, result.getTotal());
        assertEquals("Test Product", result.getData().get(0).getProductName());
        verify(productFlow).searchProducts(any(), any(), any(), any());
    }

    @Test
    void testUploadProductsTsv() throws Exception {
        // Arrange
        ProductForm form = new ProductForm();
        form.setProductName("Test Product");
        form.setMrp(BigDecimal.valueOf(100.0));
        form.setClientId(1);
        form.setBarcode("BAR001");

        // Mock client API call
        doNothing().when(productFlow).validateClientExists(1);
        when(productFlow.bulkCreateProducts(any())).thenReturn(List.of(createProductEntity(1, "Test Product", BigDecimal.valueOf(100.0), 1, "BAR001")));

        String tsvContent = "productName\tmrp\tclientId\tbarcode\nTest Product\t100.00\t1\tBAR001";
        MockMultipartFile file = new MockMultipartFile(
                "file", "products.tsv", "text/tab-separated-values", tsvContent.getBytes()
        );

        // Act
        TsvUploadResult<ProductData> result = productDto.uploadProductsTsv(file);

        // Assert
        assertTrue(result.isSuccess());
        assertEquals(1, result.getData().size());
        assertEquals("Test Product", result.getData().get(0).getProductName());
    }

    @Test
    void testUploadProductsTsv_emptyFile_throwsException() {
        // Act & Assert
        ApiException exception = assertThrows(ApiException.class, () -> productDto.uploadProductsTsv(null));
        assertEquals("BAD_REQUEST", exception.getStatus().name());
        assertTrue(exception.getMessage().contains("Empty file"));
    }

    private com.increff.pos.entity.ProductEntity createProductEntity(Integer id, String name, BigDecimal mrp, Integer clientId, String barcode) {
        com.increff.pos.entity.ProductEntity product = new com.increff.pos.entity.ProductEntity();
        product.setId(id);
        product.setProductName(name);
        product.setMrp(mrp);
        product.setClientId(clientId);
        product.setBarcode(barcode);
        return product;
    }

    private ProductForm createProductForm(String name, BigDecimal mrp, Integer clientId, String barcode) {
        ProductForm form = new ProductForm();
        form.setProductName(name);
        form.setMrp(mrp);
        form.setClientId(clientId);
        form.setBarcode(barcode);
        return form;
    }
}
